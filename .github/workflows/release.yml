name: Build and Pre-release

on:
  push:
    branches:
      - main
      - master

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Setup pnpm
      uses: pnpm/action-setup@v3
      with:
        version: 10.15.0
    
    - name: Get latest version and commit info
      id: version
      run: |
        # Get the latest tag, default to v0.0.1 if none exists
        LATEST_TAG=$(git tag --list 'v*' --sort=-v:refname | head -1)
        if [ -z "$LATEST_TAG" ]; then
          LATEST_TAG="v0.0.1"
        fi

        VERSION=${LATEST_TAG#v}
        
        # Create pre-release version
        PRE_RELEASE_VERSION="${VERSION%-pre}-pre"
        
        echo "pre_release_version=${PRE_RELEASE_VERSION}" >> $GITHUB_OUTPUT
        echo "latest_tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
    
    - name: Get commit titles since last tag
      id: commits
      run: |
        LATEST_TAG="${{ steps.version.outputs.latest_tag }}"
        
        # Get commit titles since the last tag (or all commits if no tag)
        if git tag --list | grep -q "^${LATEST_TAG}$"; then
          COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=format:"- %s" --no-merges)
        else
          COMMITS=$(git log --pretty=format:"- %s" --no-merges)
        fi
        
        # If no commits since last tag, use the latest commit
        if [ -z "$COMMITS" ]; then
          COMMITS=$(git log -1 --pretty=format:"- %s")
        fi
        
        # Save to output, handling multiline
        echo "titles<<EOF" >> $GITHUB_OUTPUT
        echo "$COMMITS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Install dependencies
      run: pnpm install
    
    - name: Build project
      run: pnpm run build
    
    - name: Package extension
      run: |
        cd dist
        zip -r ../vodozedom-${{ steps.version.outputs.pre_release_version }}.zip .
        cd ..
        cp vodozedom-${{ steps.version.outputs.pre_release_version }}.zip vodozedom-${{ steps.version.outputs.pre_release_version }}.xpi
    
    - name: Create Pre-release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.pre_release_version }}
        name: Pre-release v${{ steps.version.outputs.pre_release_version }}
        body: |
          ## Changes in this pre-release
          
          ${{ steps.commits.outputs.titles }}
          
          ---
          
          ## Installation
          
          ### Chrome
          
          **ZIP File:**
          1. Download `vodozedom-${{ steps.version.outputs.pre_release_version }}.zip`
          2. Extract the ZIP file to a folder
          3. Open Chrome and navigate to `chrome://extensions/`
          4. Enable "Developer mode" (toggle in top right)
          5. Click "Load unpacked"
          6. Select the extracted folder
          
          ### Firefox
          
          **XPI File (Recommended):**
          1. Download `vodozedom-${{ steps.version.outputs.pre_release_version }}.xpi`
          2. Open Firefox and navigate to `about:addons`
          3. Click the gear icon and select "Install Add-on From File..."
          4. Select the downloaded XPI file
          
          **ZIP File (Alternative):**
          1. Download and extract `vodozedom-${{ steps.version.outputs.pre_release_version }}.zip` to a folder
          2. Open Firefox and navigate to `about:debugging`
          3. Click "This Firefox" then "Load Temporary Add-on"
          4. Select the `manifest.json` file from the extracted folder
          
          ---
          Built from commit: ${{ github.sha }}
        prerelease: true
        files: |
          vodozedom-${{ steps.version.outputs.pre_release_version }}.zip
          vodozedom-${{ steps.version.outputs.pre_release_version }}.xpi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
